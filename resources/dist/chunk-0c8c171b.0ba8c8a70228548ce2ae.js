(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-0c8c171b"],{"20f9":function(e,t,a){},"9e60":function(e,t,a){"use strict";a("20f9")},ecfa:function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"department-management"},[t("div",{staticClass:"content-container"},[t("div",{staticClass:"department-tree-container"},[t("div",{staticClass:"tree-header"},[t("div",{staticClass:"tree-actions"},[t("el-input",{staticStyle:{width:"100%"},attrs:{placeholder:"输入关键字进行过滤",size:"small"},model:{value:e.filterText,callback:function(t){e.filterText=t},expression:"filterText"}}),t("el-button",{directives:[{name:"permission",rawName:"v-permission",value:"system.department.add",expression:"'system.department.add'"}],attrs:{size:"small",icon:"el-icon-plus",type:"primary"},on:{click:e.showAddDialog}},[e._v(" 添加部门 ")])],1)]),t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{"min-height":"200px"}},[t("el-tree",{ref:"deptTree",attrs:{data:e.departmentTree,props:e.defaultProps,"filter-node-method":e.filterNode,"node-key":"id","default-expand-all":"","highlight-current":"","expand-on-click-node":!1},on:{"node-click":e.handleNodeClick},scopedSlots:e._u([{key:"default",fn:function({data:a}){return t("span",{staticClass:"custom-tree-node"},[t("span",[t("i",{staticClass:"el-icon-office-building",staticStyle:{"margin-right":"5px"}}),e._v(" "+e._s(a.department_name)+" "),a.user_count>0?t("el-tag",{attrs:{size:"mini",type:"success"}},[e._v("在职"+e._s(a.user_count)+"人")]):e._e()],1),t("span",{staticClass:"node-actions"},[t("el-button",{attrs:{type:"text",size:"mini"},on:{click:function(t){return t.stopPropagation(),e.handleAddChild(a)}}},[e._v(" 添加 ")]),t("el-button",{attrs:{type:"text",size:"mini"},on:{click:function(t){return t.stopPropagation(),e.handleEdit(a)}}},[e._v(" 编辑 ")]),t("el-button",{staticClass:"delete-btn",attrs:{type:"text",size:"mini"},on:{click:function(t){return t.stopPropagation(),e.handleDelete(a)}}},[e._v(" 删除 ")])],1)])}}])}),e.loading||0!==e.departmentTree.length?e._e():t("div",{staticClass:"empty-data"},[t("el-empty",{attrs:{description:"暂无部门数据"}},[t("el-button",{attrs:{type:"primary"},on:{click:e.showAddDialog}},[e._v("添加部门")])],1)],1)],1)]),e.currentDepartment?t("div",{staticClass:"department-detail-container"},[t("div",{staticClass:"detail-header"},[t("span",[e._v("部门详情")]),t("el-button",{staticStyle:{display:"flex","margin-left":"auto"},attrs:{size:"small",type:"primary"},on:{click:e.showAddDialog}},[e._v("添加部门")])],1),t("div",{staticClass:"detail-content"},[t("el-descriptions",{attrs:{column:1,border:""}},[t("el-descriptions-item",{attrs:{label:"部门名称"}},[e._v(e._s(e.currentDepartment.department_name))]),t("el-descriptions-item",{attrs:{label:"部门编码"}},[e._v(e._s(e.currentDepartment.department_code))]),t("el-descriptions-item",{attrs:{label:"部门描述"}},[e._v(e._s(e.currentDepartment.description||"无"))]),t("el-descriptions-item",{attrs:{label:"上级部门"}},[e._v(e._s(e.getParentDepartmentName(e.currentDepartment.parent_id)))]),t("el-descriptions-item",{attrs:{label:"负责人"}},[e.currentDepartment.manager?t("div",[t("el-tag",{attrs:{type:"primary",size:"small"}},[e._v(" "+e._s(e.currentDepartment.manager.real_name)+" ")])],1):t("span",{staticStyle:{color:"#909399"}},[e._v("未设置")])]),t("el-descriptions-item",{attrs:{label:"排序"}},[e._v(e._s(e.currentDepartment.sort_order||0))]),t("el-descriptions-item",{attrs:{label:"创建时间"}},[e._v(e._s(e.currentDepartment.created_at))]),t("el-descriptions-item",{attrs:{label:"人员统计"}},[t("span",{staticClass:"staff-stats"},[t("el-tag",{attrs:{type:"primary"}},[e._v("在职人员: "+e._s(e.currentDepartment.user_count||0)+"人")])],1)]),t("el-descriptions-item",{attrs:{label:"排序"}},[e._v(e._s(e.currentDepartment.sort_order||e.currentDepartment.sort))]),t("el-descriptions-item",{attrs:{label:"备注"}},[e._v(e._s(e.currentDepartment.description||e.currentDepartment.remark||"无"))])],1)],1),t("div",{staticClass:"staff-management"},[e._m(0),t("div",{staticClass:"staff-filter"},[t("el-radio-group",{attrs:{size:"small"},model:{value:e.staffStatusFilter,callback:function(t){e.staffStatusFilter=t},expression:"staffStatusFilter"}},[t("el-radio-button",{attrs:{label:"all"}},[e._v("全部")]),t("el-radio-button",{attrs:{label:"active"}},[e._v("在职")]),t("el-radio-button",{attrs:{label:"inactive"}},[e._v("离职")])],1)],1),t("el-table",{staticStyle:{width:"100%"},attrs:{data:e.filteredStaffList,stripe:"",size:"small"}},[t("el-table-column",{attrs:{prop:"name",align:"center",label:"姓名",width:"120"}}),t("el-table-column",{attrs:{prop:"jobTitle",align:"center",label:"职位",width:"120"}}),t("el-table-column",{attrs:{align:"center",label:"担任职务"},scopedSlots:e._u([{key:"default",fn:function(a){return[a.row.leadershipRoles&&a.row.leadershipRoles.length>0?t("div",e._l(a.row.leadershipRoles,(function(a){return t("el-tag",{key:a.departmentId,staticStyle:{"margin-right":"4px","margin-bottom":"2px"},attrs:{size:"mini",type:"warning"}},[e._v(" "+e._s(a.departmentName)+"负责人 ")])})),1):t("span",{staticStyle:{color:"#909399","font-size":"12px"}},[e._v("普通员工")])]}}],null,!1,3011865234)}),t("el-table-column",{attrs:{prop:"phone",align:"center",label:"联系电话",width:"130"}}),t("el-table-column",{attrs:{prop:"email",align:"center",label:"邮箱"}}),t("el-table-column",{attrs:{prop:"status",align:"center",label:"状态",width:"80"},scopedSlots:e._u([{key:"default",fn:function(a){return[t("el-tag",{attrs:{type:1===a.row.status?"success":"info",size:"small"}},[e._v(" "+e._s(1===a.row.status?"在职":"离职")+" ")])]}}],null,!1,2320587706)}),t("el-table-column",{attrs:{prop:"joinDate",align:"center",label:"入职日期",width:"100"}}),t("el-table-column",{attrs:{prop:"leaveDate",align:"center",label:"离职日期",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.leaveDate||"-")+" ")]}}],null,!1,403794015)})],1)],1)]):e._e()]),t("el-dialog",{attrs:{title:e.dialogTitle,visible:e.dialogVisible,width:"600px","append-to-body":"","close-on-click-modal":!1},on:{"update:visible":function(t){e.dialogVisible=t}}},[t("el-form",{ref:"departmentForm",attrs:{model:e.departmentForm,rules:e.rules,"label-width":"100px"}},[t("el-form-item",{attrs:{label:"上级部门"}},[t("el-cascader",{attrs:{options:e.availableDepartmentOptions,props:{checkStrictly:!0,value:"value",label:"label"},clearable:"",placeholder:"顶级部门",disabled:e.isEdit&&0===e.departmentForm.parentId.length},model:{value:e.departmentForm.parentId,callback:function(t){e.$set(e.departmentForm,"parentId",t)},expression:"departmentForm.parentId"}}),t("div",{staticStyle:{color:"#909399","font-size":"12px","margin-top":"4px"}},[e._v(" 最多支持4级部门层级 ")])],1),t("el-form-item",{attrs:{label:"部门名称",prop:"name"}},[t("el-input",{model:{value:e.departmentForm.name,callback:function(t){e.$set(e.departmentForm,"name",t)},expression:"departmentForm.name"}})],1),t("el-form-item",{attrs:{label:"部门编码",prop:"code"}},[t("el-input",{attrs:{disabled:e.isEdit},model:{value:e.departmentForm.code,callback:function(t){e.$set(e.departmentForm,"code",t)},expression:"departmentForm.code"}})],1),t("el-form-item",{attrs:{label:"负责人"}},[t("el-select",{staticStyle:{width:"100%"},attrs:{multiple:"",filterable:"",placeholder:"选择负责人（可多选）"},model:{value:e.departmentForm.leaderIds,callback:function(t){e.$set(e.departmentForm,"leaderIds",t)},expression:"departmentForm.leaderIds"}},e._l(e.activeStaffOptions,(function(a){return t("el-option",{key:a.id,attrs:{label:`${a.name} - ${a.jobTitle}`,value:a.id}},[t("span",{staticStyle:{float:"left"}},[e._v(e._s(a.name))]),t("span",{staticStyle:{float:"right",color:"#8492a6","font-size":"13px"}},[e._v(e._s(a.jobTitle))])])})),1),t("div",{staticStyle:{color:"#909399","font-size":"12px","margin-top":"4px"}},[e._v(" 支持选择多个负责人，员工可身兼多职 ")])],1),t("el-form-item",{attrs:{label:"联系电话"}},[t("el-input",{model:{value:e.departmentForm.phone,callback:function(t){e.$set(e.departmentForm,"phone",t)},expression:"departmentForm.phone"}})],1),t("el-form-item",{attrs:{label:"邮箱"}},[t("el-input",{model:{value:e.departmentForm.email,callback:function(t){e.$set(e.departmentForm,"email",t)},expression:"departmentForm.email"}})],1),t("el-form-item",{attrs:{label:"排序"}},[t("el-input-number",{attrs:{min:1,max:999},model:{value:e.departmentForm.sort,callback:function(t){e.$set(e.departmentForm,"sort",t)},expression:"departmentForm.sort"}})],1),t("el-form-item",{attrs:{label:"备注"}},[t("el-input",{attrs:{type:"textarea",rows:3},model:{value:e.departmentForm.remark,callback:function(t){e.$set(e.departmentForm,"remark",t)},expression:"departmentForm.remark"}})],1)],1),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v("取 消")]),t("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.submitForm}},[e._v("确 定")])],1)],1),t("el-dialog",{attrs:{title:e.staffDialogTitle,visible:e.staffDialogVisible,width:"500px","append-to-body":"","close-on-click-modal":!1},on:{"update:visible":function(t){e.staffDialogVisible=t}}},[t("el-form",{ref:"staffForm",attrs:{model:e.staffForm,rules:e.staffRules,"label-width":"100px"}},[t("el-form-item",{attrs:{label:"姓名",prop:"name"}},[t("el-input",{model:{value:e.staffForm.name,callback:function(t){e.$set(e.staffForm,"name",t)},expression:"staffForm.name"}})],1),t("el-form-item",{attrs:{label:"职位",prop:"jobTitle"}},[t("el-input",{model:{value:e.staffForm.jobTitle,callback:function(t){e.$set(e.staffForm,"jobTitle",t)},expression:"staffForm.jobTitle"}})],1),t("el-form-item",{attrs:{label:"联系电话"}},[t("el-input",{model:{value:e.staffForm.phone,callback:function(t){e.$set(e.staffForm,"phone",t)},expression:"staffForm.phone"}})],1),t("el-form-item",{attrs:{label:"邮箱"}},[t("el-input",{model:{value:e.staffForm.email,callback:function(t){e.$set(e.staffForm,"email",t)},expression:"staffForm.email"}})],1),t("el-form-item",{attrs:{label:"入职日期",prop:"joinDate"}},[t("el-date-picker",{attrs:{type:"date",placeholder:"选择入职日期","value-format":"yyyy-MM-dd"},model:{value:e.staffForm.joinDate,callback:function(t){e.$set(e.staffForm,"joinDate",t)},expression:"staffForm.joinDate"}})],1)],1),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.staffDialogVisible=!1}}},[e._v("取 消")]),t("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.submitStaffForm}},[e._v("确 定")])],1)],1)],1)},s=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"staff-header"},[t("span",[e._v("人员管理")])])}],r=(a("14d9"),a("e9f5"),a("910d"),a("f665"),a("7d54"),a("ab43"),{name:"DepartmentManagement",data(){return{filterText:"",departmentList:[],departmentTree:[],departmentOptions:[],availableDepartmentOptions:[],currentDepartment:null,staffList:[],currentStaffList:[],activeStaffOptions:[],staffStatusFilter:"all",loading:!1,dialogVisible:!1,dialogTitle:"添加部门",isEdit:!1,isAddChild:!1,parentDepartment:null,staffDialogVisible:!1,staffDialogTitle:"添加人员",isStaffEdit:!1,departmentForm:{id:null,parentId:[],name:"",code:"",leaderIds:[],phone:"",email:"",sort:1,remark:""},staffForm:{id:null,departmentId:null,name:"",jobTitle:"",phone:"",email:"",joinDate:"",leaveDate:""},defaultProps:{children:"children",label:"department_name"},rules:{name:[{required:!0,message:"请输入部门名称",trigger:"blur"}],code:[{required:!0,message:"请输入部门编码",trigger:"blur"},{pattern:/^[a-zA-Z0-9_]+$/,message:"部门编码只能包含字母、数字和下划线",trigger:"blur"}]},staffRules:{name:[{required:!0,message:"请输入姓名",trigger:"blur"}],jobTitle:[{required:!0,message:"请输入职位",trigger:"blur"}],joinDate:[{required:!0,message:"请选择入职日期",trigger:"change"}]}}},computed:{filteredStaffList(){return"all"===this.staffStatusFilter?this.currentStaffList:"active"===this.staffStatusFilter?this.currentStaffList.filter(e=>1===e.status):"inactive"===this.staffStatusFilter?this.currentStaffList.filter(e=>0===e.status):this.currentStaffList}},watch:{filterText(e){this.$refs.deptTree.filter(e)},currentStaffList:{handler(e){console.log("currentStaffList 更新:",e.length,"人")},immediate:!0}},created(){this.fetchData(),this.getManagers()},methods:{async fetchData(){this.loading=!0;try{const e=await this.$api.department.getList({keyword:this.filterText});0===e.data.code?(console.log("API返回的原始数据:",e.data.data),this.departmentTree=e.data.data||[],this.departmentList=e.data.data||[],console.log("部门树形数据:",this.departmentTree),this.buildDepartmentOptions(),this.departmentTree.length>0?(this.currentDepartment=this.departmentTree[0],console.log("当前选中部门:",this.currentDepartment),this.$nextTick(()=>{this.loadStaffListFromAPI(this.currentDepartment.id)})):(console.warn("部门树形数据为空"),this.currentStaffList=[])):(console.error("API返回错误:",e.data),this.$message.error(e.data.msg||"获取部门列表失败"))}catch(e){console.error("获取部门列表失败:",e),console.error("错误详情:",e.response||e.message),this.$message.error("获取部门列表失败，使用模拟数据"),this.fetchDataMock()}finally{this.loading=!1}},buildDepartmentOptions(){this.departmentOptions=this.buildSelectOptions(this.departmentTree),this.availableDepartmentOptions=this.buildSelectOptions(this.departmentTree)},buildSelectOptions(e){return e.map(e=>({value:e.id,label:e.department_name,children:e.children&&e.children.length>0?this.buildSelectOptions(e.children):void 0}))},async getDepartmentDetail(e){try{const t=await this.$api.department.getDetail(e);return 0===t.data.code?t.data.data:(this.$message.error(t.data.msg||"获取部门详情失败"),null)}catch(t){return console.error("获取部门详情失败:",t),this.$message.error("获取部门详情失败"),null}},async getManagers(){try{const e=await this.$api.department.getManagers();0===e.data.code?this.activeStaffOptions=e.data.data.map(e=>({id:e.id,name:e.real_name,jobTitle:e.position||"员工",value:e.id,label:`${e.real_name}(${e.username})`})):this.buildActiveStaffOptions()}catch(e){console.error("获取负责人列表失败:",e),this.buildActiveStaffOptions()}},async loadStaffListFromAPI(e){try{const t=await this.$api.user.getList({department_id:e});0===t.data.code?(this.currentStaffList=t.data.data.map(e=>({id:e.id,name:e.real_name||e.username,jobTitle:e.position||"员工",phone:e.phone||"",email:e.email||"",status:e.status,joinDate:e.created_at?this.$moment(e.created_at).format("YYYY-MM-DD"):"",leaveDate:0===e.status&&e.updated_at?this.$moment(e.updated_at).format("YYYY-MM-DD"):"",departmentId:e.department?e.department.id:null,departmentName:e.department?e.department.name:""})),this.$nextTick(()=>{this.$forceUpdate()})):(console.log("API获取人员失败，使用模拟数据"),this.loadStaffList(e))}catch(t){console.error("获取部门员工失败:",t),this.loadStaffList(e)}},getParentDepartmentName(e){if(!e||0===e)return"无";const t=(e,a)=>{for(const i of e){if(i.id===a)return i;if(i.children&&i.children.length>0){const e=t(i.children,a);if(e)return e}}return null},a=t(this.departmentList,e);return a?a.department_name:"未知"},fetchDataMock(){this.loading=!0,setTimeout(()=>{this.departmentList=[{id:1,parentId:0,name:"睿道集团",code:"GROUP",leaderIds:[1],phone:"13800138000",email:"ceo@example.com",sort:1,status:1,createTime:"2023-01-01 00:00:00",remark:"集团总部",level:1},{id:2,parentId:1,name:"成都睿道",code:"CD_BRANCH",leaderIds:[2],phone:"13800138001",email:"cd@example.com",sort:1,status:1,createTime:"2023-01-01 00:00:00",remark:"成都分公司",level:2},{id:3,parentId:1,name:"北京睿道",code:"BJ_BRANCH",leaderIds:[3],phone:"13800138002",email:"bj@example.com",sort:2,status:1,createTime:"2023-01-01 00:00:00",remark:"北京分公司",level:2},{id:4,parentId:2,name:"技术中心",code:"TECH_CENTER",leaderIds:[4,5],phone:"13800138003",email:"tech@example.com",sort:1,status:1,createTime:"2023-01-01 00:00:00",remark:"负责技术研发",level:3},{id:5,parentId:2,name:"市场中心",code:"MARKET_CENTER",leaderIds:[6],phone:"13800138004",email:"market@example.com",sort:2,status:1,createTime:"2023-01-01 00:00:00",remark:"负责市场营销",level:3},{id:6,parentId:3,name:"运营中心",code:"OPS_CENTER",leaderIds:[7],phone:"13800138005",email:"ops@example.com",sort:1,status:1,createTime:"2023-01-01 00:00:00",remark:"负责运营管理",level:3},{id:7,parentId:4,name:"研发部",code:"RD_DEPT",leaderIds:[8],phone:"13800138006",email:"rd@example.com",sort:1,status:1,createTime:"2023-01-01 00:00:00",remark:"负责产品研发",level:4},{id:8,parentId:4,name:"测试部",code:"QA_DEPT",leaderIds:[9],phone:"13800138007",email:"qa@example.com",sort:2,status:1,createTime:"2023-01-01 00:00:00",remark:"负责产品测试",level:4},{id:9,parentId:5,name:"销售部",code:"SALES_DEPT",leaderIds:[10],phone:"13800138008",email:"sales@example.com",sort:1,status:1,createTime:"2023-01-01 00:00:00",remark:"负责产品销售",level:4},{id:10,parentId:6,name:"人事部",code:"HR_DEPT",leaderIds:[11,12],phone:"13800138009",email:"hr@example.com",sort:1,status:1,createTime:"2023-01-01 00:00:00",remark:"负责人力资源",level:4}],this.staffList=[{id:1,departmentId:1,name:"张总",jobTitle:"集团CEO",phone:"13900139001",email:"ceo@example.com",joinDate:"2020-01-01",leaveDate:"",status:1},{id:2,departmentId:2,name:"李总",jobTitle:"成都总经理",phone:"13900139002",email:"cdceo@example.com",joinDate:"2020-03-01",leaveDate:"",status:1},{id:3,departmentId:3,name:"王总",jobTitle:"北京总经理",phone:"13900139003",email:"bjceo@example.com",joinDate:"2020-03-01",leaveDate:"",status:1},{id:4,departmentId:4,name:"刘经理",jobTitle:"技术总监",phone:"13900139004",email:"cto@example.com",joinDate:"2020-06-01",leaveDate:"",status:1},{id:5,departmentId:4,name:"陈经理",jobTitle:"架构师",phone:"13900139005",email:"arch@example.com",joinDate:"2020-08-01",leaveDate:"",status:1},{id:6,departmentId:5,name:"赵经理",jobTitle:"市场总监",phone:"13900139006",email:"market@example.com",joinDate:"2020-05-01",leaveDate:"",status:1},{id:7,departmentId:6,name:"钱经理",jobTitle:"运营总监",phone:"13900139007",email:"ops@example.com",joinDate:"2020-07-01",leaveDate:"",status:1},{id:8,departmentId:7,name:"孙经理",jobTitle:"研发经理",phone:"13900139008",email:"rdmgr@example.com",joinDate:"2021-01-01",leaveDate:"",status:1},{id:9,departmentId:7,name:"周三",jobTitle:"高级开发工程师",phone:"13900139009",email:"dev1@example.com",joinDate:"2021-03-01",leaveDate:"",status:1},{id:10,departmentId:7,name:"吴四",jobTitle:"前端开发工程师",phone:"13900139010",email:"fe@example.com",joinDate:"2021-06-01",leaveDate:"",status:1},{id:11,departmentId:8,name:"郑五",jobTitle:"测试经理",phone:"13900139011",email:"qamgr@example.com",joinDate:"2021-02-01",leaveDate:"",status:1},{id:12,departmentId:8,name:"王六",jobTitle:"自动化测试工程师",phone:"13900139012",email:"autoqa@example.com",joinDate:"2021-05-01",leaveDate:"",status:1},{id:13,departmentId:9,name:"李七",jobTitle:"销售经理",phone:"13900139013",email:"salesmgr@example.com",joinDate:"2021-04-01",leaveDate:"",status:1},{id:14,departmentId:9,name:"张八",jobTitle:"销售代表",phone:"13900139014",email:"sales1@example.com",joinDate:"2021-08-01",leaveDate:"",status:1},{id:15,departmentId:10,name:"赵九",jobTitle:"HR总监",phone:"13900139015",email:"hr@example.com",joinDate:"2020-12-01",leaveDate:"",status:1},{id:16,departmentId:10,name:"钱十",jobTitle:"HR专员",phone:"13900139016",email:"hrspec@example.com",joinDate:"2021-09-01",leaveDate:"",status:1}],this.calculateDepartmentLevels(),this.calculateStaffStats(),this.calculateLeadershipRoles(),this.departmentTree=this.convertToTree(this.departmentList),this.buildDepartmentOptions(),this.buildActiveStaffOptions(),this.departmentTree.length>0&&(this.currentDepartment=this.departmentTree[0],this.loadStaffList(this.currentDepartment.id)),this.loading=!1},500)},calculateDepartmentLevels(){const e=t=>{if(0===t.parentId)t.level=1;else{const a=this.departmentList.find(e=>e.id===t.parentId);a&&(a.level||e(a),t.level=a.level+1)}};this.departmentList.forEach(t=>{t.level||e(t)})},calculateLeadershipRoles(){this.staffList.forEach(e=>{e.leadershipRoles=[],this.departmentList.forEach(t=>{t.leaderIds&&t.leaderIds.includes(e.id)&&e.leadershipRoles.push({departmentId:t.id,departmentName:t.name})})})},buildActiveStaffOptions(){this.activeStaffOptions=this.staffList.filter(e=>1===e.status)},getLevelTagType(e){const t=["","danger","warning","success","primary"];return t[e]||"info"},getLevelText(e){const t=["","集团","分公司","中心","部门"];return t[e]||"未知"},getNodeIcon(e){const t=["","el-icon-office-building","el-icon-bank-card","el-icon-coordinate","el-icon-user"];return t[e]||"el-icon-folder"},calculateDepartmentLevel(e){if(!e)return 0;if(e.level)return e.level;if(0===e.parent_id||!e.parent_id)return 1;const t=this.findDepartmentById(this.departmentList,e.parent_id);return t?this.calculateDepartmentLevel(t)+1:1},findDepartmentById(e,t){for(const a of e){if(a.id===t)return a;if(a.children&&a.children.length>0){const e=this.findDepartmentById(a.children,t);if(e)return e}}return null},handleAddChild(e){const t=this.calculateDepartmentLevel(e);t>=4?this.$message.warning("已达到最大层级限制（4级），无法继续添加子部门"):(this.dialogTitle=`添加 "${e.department_name}" 的子部门`,this.isEdit=!1,this.isAddChild=!0,this.parentDepartment=e,this.departmentForm={id:null,parentId:[e.id],name:"",code:"",leaderIds:[],phone:"",email:"",sort:1,remark:""},this.dialogVisible=!0,this.$nextTick(()=>{this.$refs.departmentForm&&this.$refs.departmentForm.clearValidate()}))},handleEdit(e){this.dialogTitle="编辑部门",this.isEdit=!0,this.isAddChild=!1,this.departmentForm={id:e.id,parentId:e.parent_id&&0!==e.parent_id?[e.parent_id]:[],name:e.department_name,code:e.department_code,leaderIds:e.manager?[e.manager.id]:[],phone:e.phone||"",email:e.email||"",sort:e.sort_order||0,remark:e.description||""},this.dialogVisible=!0,this.$nextTick(()=>{this.$refs.departmentForm&&this.$refs.departmentForm.clearValidate()})},handleDelete(e){this.$confirm("确认删除该部门吗？删除后不可恢复！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const t=await this.$api.department.delete(e.id);0===t.data.code?(this.$message.success("部门删除成功"),this.fetchData(),this.currentDepartment&&this.currentDepartment.id===e.id&&(this.currentDepartment=null)):this.$message.error(t.data.msg||"删除失败")}catch(t){console.error("删除部门失败:",t),this.$message.error("删除失败，请稍后重试")}}).catch(()=>{this.$message.info("已取消删除")})},calculateStaffStats(){this.departmentList.forEach(e=>{const t=this.staffList.filter(t=>t.departmentId===e.id),a=t.filter(e=>1===e.status),i=t.filter(e=>0===e.status);e.staffCount=t.length,e.activeStaffCount=a.length,e.inactiveStaffCount=i.length,e.user_count=a.length})},loadStaffList(e){this.currentStaffList=this.staffList.filter(t=>t.departmentId===e)},showAddStaffDialog(){this.staffDialogTitle="添加人员",this.isStaffEdit=!1,this.staffForm={id:null,departmentId:this.currentDepartment.id,name:"",jobTitle:"",phone:"",email:"",joinDate:"",leaveDate:""},this.staffDialogVisible=!0,this.$nextTick(()=>{this.$refs.staffForm&&this.$refs.staffForm.clearValidate()})},handleEditStaff(e){this.staffDialogTitle="编辑人员",this.isStaffEdit=!0,this.staffForm={id:e.id,departmentId:e.departmentId,name:e.name,jobTitle:e.jobTitle,phone:e.phone||"",email:e.email||"",joinDate:e.joinDate,leaveDate:e.leaveDate||""},this.staffDialogVisible=!0,this.$nextTick(()=>{this.$refs.staffForm&&this.$refs.staffForm.clearValidate()})},handleLeaveStaff(e){this.$confirm("确认将该员工设为离职状态吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{const t=this.staffList.find(t=>t.id===e.id);t&&(t.status=0,t.leaveDate=this.getCurrentDate(),this.calculateStaffStats(),this.loadStaffList(this.currentDepartment.id),this.$message({type:"success",message:"离职操作成功!"}))}).catch(()=>{this.$message({type:"info",message:"已取消操作"})})},handleRehireStaff(e){this.$confirm("确认将该员工重新入职吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{const t=this.staffList.find(t=>t.id===e.id);t&&(t.status=1,t.leaveDate="",this.calculateStaffStats(),this.loadStaffList(this.currentDepartment.id),this.$message({type:"success",message:"重新入职操作成功!"}))}).catch(()=>{this.$message({type:"info",message:"已取消操作"})})},handleDeleteStaff(e){this.$confirm("确认删除该员工吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{const t=this.staffList.findIndex(t=>t.id===e.id);t>-1&&(this.staffList.splice(t,1),this.calculateStaffStats(),this.loadStaffList(this.currentDepartment.id),this.$message({type:"success",message:"删除成功!"}))}).catch(()=>{this.$message({type:"info",message:"已取消删除"})})},async submitForm(){this.$refs.departmentForm.validate(async e=>{if(e)try{const e={department_code:this.departmentForm.code,department_name:this.departmentForm.name,parent_id:this.departmentForm.parentId&&this.departmentForm.parentId.length>0?this.departmentForm.parentId[this.departmentForm.parentId.length-1]:0,manager_id:this.departmentForm.leaderIds.length>0?this.departmentForm.leaderIds[0]:null,description:this.departmentForm.remark,sort_order:this.departmentForm.sort};let t;t=this.isEdit?await this.$api.department.update(this.departmentForm.id,e):await this.$api.department.create(e),0===t.data.code?(this.$message.success(this.isEdit?"部门更新成功":"部门创建成功"),this.dialogVisible=!1,this.fetchData()):this.$message.error(t.data.msg||"操作失败")}catch(t){console.error("提交部门信息失败:",t),this.$message.error("操作失败，请稍后重试")}})},submitStaffForm(){this.$refs.staffForm.validate(e=>{if(!e)return!1;if(this.isStaffEdit){const e=this.staffList.find(e=>e.id===this.staffForm.id);e&&Object.assign(e,this.staffForm)}else{const e={...this.staffForm,id:this.staffList.length+1};this.staffList.push(e)}this.calculateStaffStats(),this.loadStaffList(this.currentDepartment.id),this.staffDialogVisible=!1,this.$message({type:"success",message:this.isStaffEdit?"修改成功!":"添加成功!"})})},getCurrentDate(){const e=new Date;return e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0")},convertToTree(e){const t=e.filter(e=>0===e.parentId),a=t=>t.map(t=>{const i=e.filter(e=>e.parentId===t.id);return t.leaderIds&&t.leaderIds.length>0?t.leaders=this.staffList.filter(e=>t.leaderIds.includes(e.id)):t.leaders=[],i.length>0?{...t,children:a(i)}:{...t}});return a(t)},setParentName(e){if(0!==e.parent_id&&e.parent_id){const t=this.findDepartmentById(this.departmentTree,e.parent_id);e.parentName=t?t.department_name||t.name:"未知"}else e.parentName="无";e.children&&e.children.length>0&&e.children.forEach(e=>{this.setParentName(e)})},filterNode(e,t){return!e||-1!==t.department_name.indexOf(e)},refreshTree(){this.filterText="",this.fetchData()},expandAll(){this.$refs.deptTree.expandAll()},collapseAll(){this.$refs.deptTree.collapseAll()},handleNodeClick(e){this.currentDepartment=e,console.log("选中部门:",e),this.loadStaffListFromAPI(this.currentDepartment.id)},showAddDialog(){this.dialogTitle="添加部门",this.isEdit=!1,this.isAddChild=!1,this.departmentForm={id:null,parentId:[],name:"",code:"",leaderIds:[],phone:"",email:"",sort:1,remark:""},this.dialogVisible=!0,this.$nextTick(()=>{this.$refs.departmentForm&&this.$refs.departmentForm.clearValidate()})}}}),n=r,l=(a("9e60"),a("2877")),o=Object(l["a"])(n,i,s,!1,null,null,null);t["default"]=o.exports}}]);