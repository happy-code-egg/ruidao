(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3131b48e"],{b226:function(e,t,i){"use strict";i.r(t);var s=function(){var e=this,t=e._self._c;return t("div",{staticClass:"role-management"},[t("div",{staticClass:"body-part-search"},[t("el-form",{staticClass:"demo-form-inline",attrs:{inline:!0,model:e.searchForm}},[t("el-form-item",{attrs:{label:"角色名称"}},[t("el-input",{attrs:{size:"small",placeholder:"角色名称"},model:{value:e.searchForm.name,callback:function(t){e.$set(e.searchForm,"name",t)},expression:"searchForm.name"}})],1),t("el-form-item",[t("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.handleSearch}},[e._v("查询")]),t("el-button",{attrs:{size:"small"},on:{click:e.resetSearch}},[e._v("重置")]),t("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.showAddRoleDialog}},[e._v("添加角色")])],1)],1)],1),t("div",{staticClass:"body-part-content"},[t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{data:e.roleList,border:"",size:"small"}},[t("el-table-column",{attrs:{prop:"id",align:"center",label:"ID",width:"80"}}),t("el-table-column",{attrs:{prop:"name",align:"center",label:"角色名称",width:"150"}}),t("el-table-column",{attrs:{prop:"code",align:"center",label:"角色标识",width:"200"}}),t("el-table-column",{attrs:{prop:"description",align:"center",label:"角色描述","show-overflow-tooltip":""}}),t("el-table-column",{attrs:{prop:"permissionCount",align:"center",label:"权限数量",width:"120"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("span",[e._v(e._s(i.row.permissionCount||0))])]}}])}),t("el-table-column",{attrs:{prop:"createTime",align:"center",label:"创建时间",width:"200"}}),t("el-table-column",{attrs:{align:"center",label:"操作",width:"200",fixed:"right"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-button",{attrs:{size:"mini"},on:{click:function(t){return e.handleEdit(i.row)}}},[e._v("编辑")]),t("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(t){return e.handlePermissionSetting(i.row)}}},[e._v("权限设置")])]}}])})],1),t("el-pagination",{attrs:{"current-page":e.currentPage,"page-sizes":[10,20,50,100],"page-size":e.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:e.total},on:{"size-change":e.handleSizeChange,"current-change":e.handleCurrentChange}})],1),t("el-dialog",{attrs:{title:e.dialogTitle,visible:e.dialogVisible,width:"600px","append-to-body":"","close-on-click-modal":!1},on:{"update:visible":function(t){e.dialogVisible=t}}},[t("el-form",{ref:"roleForm",attrs:{model:e.roleForm,rules:e.rules,"label-width":"100px"}},[t("el-form-item",{attrs:{label:"角色名称",prop:"name"}},[t("el-input",{model:{value:e.roleForm.name,callback:function(t){e.$set(e.roleForm,"name",t)},expression:"roleForm.name"}})],1),t("el-form-item",{attrs:{label:"角色标识",prop:"code"}},[t("el-input",{attrs:{disabled:e.isEdit},model:{value:e.roleForm.code,callback:function(t){e.$set(e.roleForm,"code",t)},expression:"roleForm.code"}})],1),t("el-form-item",{attrs:{label:"角色描述",prop:"description"}},[t("el-input",{attrs:{type:"textarea",rows:3},model:{value:e.roleForm.description,callback:function(t){e.$set(e.roleForm,"description",t)},expression:"roleForm.description"}})],1)],1),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary",loading:e.submitting},on:{click:e.submitForm}},[e._v("确 定")])],1)],1),t("el-dialog",{attrs:{title:"权限设置",visible:e.permissionDialogVisible,width:"800px","append-to-body":"","close-on-click-modal":!1},on:{"update:visible":function(t){e.permissionDialogVisible=t}}},[t("div",{staticClass:"permission-setting-header"},[t("h4",[e._v("角色："+e._s(e.currentRole.name)+" ("+e._s(e.currentRole.code)+")")]),t("p",{staticClass:"role-description"},[e._v(e._s(e.currentRole.description))])]),t("div",{staticClass:"permission-container"},[t("el-tree",{ref:"permissionTree",staticStyle:{"max-height":"400px","overflow-y":"auto"},attrs:{data:e.permissionTree,"show-checkbox":"","node-key":"id","check-strictly":!1,props:e.defaultProps},scopedSlots:e._u([{key:"default",fn:function({data:i}){return t("span",{staticClass:"custom-tree-node"},[t("span",{staticClass:"node-label"},[e._v(e._s(i.name))]),t("el-tag",{staticClass:"permission-type-tag",attrs:{type:e.getPermissionTagType(i.type),size:"mini"}},[e._v(" "+e._s(e.getPermissionTypeName(i.type))+" ")])],1)}}])})],1),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.permissionDialogVisible=!1}}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary",loading:e.permissionSubmitting},on:{click:e.savePermissions}},[e._v("保存权限")])],1)])],1)},a=[],r=(i("e9f5"),i("910d"),i("7d54"),i("ab43"),{name:"RoleManagement",data(){return{searchForm:{name:""},roleList:[],loading:!1,submitting:!1,currentPage:1,pageSize:10,total:0,dialogVisible:!1,dialogTitle:"添加角色",isEdit:!1,roleForm:{id:null,name:"",code:"",description:""},rules:{name:[{required:!0,message:"请输入角色名称",trigger:"blur"}],code:[{required:!0,message:"请输入角色标识",trigger:"blur"},{pattern:/^[a-zA-Z0-9_]+$/,message:"角色标识只能包含字母、数字和下划线",trigger:"blur"}]},permissionDialogVisible:!1,permissionSubmitting:!1,currentRole:{},permissionTree:[],defaultProps:{children:"children",label:"name"}}},created(){this.fetchData(),this.getPermissionTree()},methods:{async fetchData(){this.loading=!0;try{const e={keyword:this.searchForm.name,page:this.currentPage,limit:this.pageSize},t=await this.$api.role.getList(e);0===t.data.code?(this.roleList=this.convertApiDataToLocal(t.data.data),this.total=t.data.count):this.$message.error(t.data.msg||"获取角色列表失败")}catch(e){console.error("获取角色列表失败:",e),this.$message.error("获取角色列表失败"),this.fetchDataMock()}finally{this.loading=!1}},convertApiDataToLocal(e){return e.map(e=>({id:e.id,name:e.role_name,code:e.role_code,description:e.description,permissionCount:e.permission_count,createTime:e.created_at}))},fetchDataMock(){const e=[{id:1,name:"超级管理员",code:"SUPER_ADMIN",description:"系统超级管理员，拥有所有权限",permissionCount:25,createTime:"2023-01-01 00:00:00"},{id:2,name:"管理员",code:"ADMIN",description:"系统管理员，拥有大部分权限",permissionCount:18,createTime:"2023-01-02 00:00:00"},{id:3,name:"普通用户",code:"USER",description:"普通用户，拥有基本权限",permissionCount:8,createTime:"2023-01-03 00:00:00"},{id:4,name:"客户经理",code:"CUSTOMER_MANAGER",description:"客户经理，负责客户管理相关功能",permissionCount:12,createTime:"2023-01-04 00:00:00"},{id:5,name:"财务人员",code:"FINANCE",description:"财务人员，负责财务相关功能",permissionCount:10,createTime:"2023-01-05 00:00:00"},{id:6,name:"游客",code:"VISITOR",description:"游客角色，仅有查看权限",permissionCount:3,createTime:"2023-01-06 00:00:00"}];let t=[...e];this.searchForm.name&&(t=t.filter(e=>e.name.toLowerCase().includes(this.searchForm.name.toLowerCase())));const i=(this.currentPage-1)*this.pageSize,s=i+this.pageSize;this.roleList=t.slice(i,s),this.total=t.length,this.loading=!1},async getPermissionTree(){try{const e=await this.$api.permission.getList();0===e.data.code?this.permissionTree=this.convertPermissionTreeData(e.data.data):(console.error("获取权限树失败:",e.data.msg),this.getPermissionTreeMock())}catch(e){console.error("获取权限树失败:",e),this.getPermissionTreeMock()}},convertPermissionTreeData(e){const t=e=>({id:e.id,name:e.permission_name,type:e.permission_type||e.type,children:e.children?e.children.map(t):[]});return e.map(t)},getPermissionTreeMock(){this.permissionTree=[{id:1,name:"系统管理",type:"menu",children:[{id:101,name:"用户管理",type:"page"},{id:102,name:"角色管理",type:"page"},{id:103,name:"权限管理",type:"page"},{id:104,name:"部门管理",type:"page"},{id:105,name:"系统日志",type:"page"}]},{id:2,name:"客户管理",type:"menu",children:[{id:201,name:"客户列表",type:"page"},{id:202,name:"部门客户",type:"page"},{id:203,name:"我的客户",type:"page"},{id:204,name:"公海客户",type:"page"},{id:205,name:"联系人列表",type:"page"},{id:206,name:"申请人列表",type:"page"},{id:207,name:"发明人列表",type:"page"},{id:208,name:"商机列表",type:"page"},{id:209,name:"跟进列表",type:"page"}]},{id:3,name:"合同管理",type:"menu",children:[{id:301,name:"新增合同",type:"button"},{id:302,name:"我的合同",type:"page"},{id:303,name:"合同列表",type:"page"}]},{id:4,name:"项目管理",type:"menu",children:[{id:401,name:"个人项目",type:"page"},{id:402,name:"项目查询",type:"page"},{id:403,name:"分配管理",type:"page"},{id:404,name:"核稿管理",type:"page"},{id:405,name:"项目更新",type:"page"},{id:406,name:"递交管理",type:"page"}]},{id:5,name:"财务管理",type:"menu",children:[{id:501,name:"项目费用管理",type:"page"},{id:502,name:"账单管理",type:"page"},{id:503,name:"到款管理",type:"page"},{id:504,name:"发票管理",type:"page"},{id:505,name:"缴费管理",type:"page"},{id:506,name:"付款支出管理",type:"page"},{id:507,name:"调账管理",type:"page"}]}]},handleSearch(){this.currentPage=1,this.fetchData()},resetSearch(){this.searchForm={name:""},this.handleSearch()},showAddRoleDialog(){this.dialogTitle="添加角色",this.isEdit=!1,this.roleForm={id:null,name:"",code:"",description:""},this.dialogVisible=!0,this.$nextTick(()=>{this.$refs.roleForm&&this.$refs.roleForm.clearValidate()})},handleEdit(e){this.dialogTitle="编辑角色",this.isEdit=!0,this.roleForm={id:e.id,name:e.name,code:e.code,description:e.description},this.dialogVisible=!0,this.$nextTick(()=>{this.$refs.roleForm&&this.$refs.roleForm.clearValidate()})},async handlePermissionSetting(e){this.currentRole={...e},this.permissionDialogVisible=!0,this.$nextTick(async()=>{try{const t=await this.$api.role.getPermissions(e.id);if(0===t.data.code){const e=t.data.data.checked_ids||[];await this.$nextTick(),this.$refs.permissionTree&&this.setTreeCheckedKeys(e)}else console.error("获取角色权限失败:",t.data.msg),this.setMockPermissions(e.id)}catch(t){console.error("获取角色权限失败:",t),this.setMockPermissions(e.id)}})},setMockPermissions(e){let t=[];switch(e){case 1:t=[1,101,102,103,104,105,2,201,202,203,204,205,206,207,208,209,3,301,302,303,4,401,402,403,404,405,406,5,501,502,503,504,505,506,507];break;case 2:t=[1,101,102,103,104,2,201,202,203,204,205,206,207,208,209,3,301,302,303,4,401,402,403,404,405,406];break;case 3:t=[2,201,203,4,401,402];break;case 4:t=[2,201,202,203,204,205,206,207,208,209,3,302,303];break;case 5:t=[5,501,502,503,504,505,506,507];break;case 6:t=[2,201,4,402];break;default:t=[]}this.$nextTick(()=>{this.$refs.permissionTree&&this.setTreeCheckedKeys(t)})},async savePermissions(){if(this.$refs.permissionTree){this.permissionSubmitting=!0;try{const e=this.$refs.permissionTree.getCheckedKeys(),t=this.$refs.permissionTree.getHalfCheckedKeys(),i=[...e,...t],s={role_code:this.currentRole.code,role_name:this.currentRole.name,permission_ids:i},a=await this.$api.role.update(this.currentRole.id,s);0===a.data.code?(this.$message.success("权限设置保存成功"),this.permissionDialogVisible=!1,this.fetchData()):this.$message.error(a.data.msg||"权限设置保存失败")}catch(e){console.error("保存权限设置失败:",e),this.$message.error("权限设置保存失败，请稍后重试")}finally{this.permissionSubmitting=!1}}else this.$message.error("权限树未加载完成")},async handleDelete(e){"SUPER_ADMIN"!==e.code?this.$confirm("确认删除该角色吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const t=await this.$api.role.delete(e.id);0===t.data.code?(this.$message.success("删除成功!"),this.fetchData()):this.$message.error(t.data.msg||"删除失败")}catch(t){console.error("删除角色失败:",t),this.$message.error("删除失败")}}).catch(()=>{this.$message({type:"info",message:"已取消删除"})}):this.$message.error("超级管理员角色不能删除")},submitForm(){this.$refs.roleForm.validate(async e=>{if(e){this.submitting=!0;try{const e={role_code:this.roleForm.code,role_name:this.roleForm.name,description:this.roleForm.description};let t;t=this.isEdit?await this.$api.role.update(this.roleForm.id,e):await this.$api.role.create(e),0===t.data.code?(this.$message.success(this.isEdit?"角色更新成功":"角色创建成功"),this.dialogVisible=!1,this.fetchData()):this.$message.error(t.data.msg||"操作失败")}catch(t){console.error("提交角色信息失败:",t),this.$message.error("操作失败，请稍后重试")}finally{this.submitting=!1}}})},handleSizeChange(e){this.pageSize=e,this.fetchData()},handleCurrentChange(e){this.currentPage=e,this.fetchData()},getPermissionTypeName(e){switch(e){case 1:return"菜单";case 2:return"页面";case 3:return"按钮";case 4:return"接口";default:return"未知"}},getPermissionTagType(e){switch(e){case 1:return"primary";case 2:return"info";case 3:return"success";case 4:return"warning";default:return"info"}},setTreeCheckedKeys(e){this.$refs.permissionTree&&Array.isArray(e)&&(this.$refs.permissionTree.setCheckedKeys([]),e.forEach(e=>{this.$refs.permissionTree.setChecked(e,!0,!0)}))}}}),o=r,n=(i("d119"),i("2877")),l=Object(n["a"])(o,s,a,!1,null,"267a4696",null);t["default"]=l.exports},bf1f:function(e,t,i){},d119:function(e,t,i){"use strict";i("bf1f")}}]);