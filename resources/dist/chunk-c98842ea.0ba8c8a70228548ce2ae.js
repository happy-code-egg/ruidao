(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-c98842ea"],{"13d5":function(e,t,a){"use strict";var s=a("23e7"),l=a("d58f").left,o=a("a640"),r=a("1212"),i=a("9adc"),n=!i&&r>79&&r<83,c=n||!o("reduce");s({target:"Array",proto:!0,forced:c},{reduce:function(e){var t=arguments.length;return l(this,e,t,t>1?arguments[1]:void 0)}})},3741:function(e,t,a){},"3b94":function(e,t,a){},8558:function(e,t,a){"use strict";var s=a("cfe9"),l=a("b5db"),o=a("c6b6"),r=function(e){return l.slice(0,e.length)===e};e.exports=function(){return r("Bun/")?"BUN":r("Cloudflare-Workers")?"CLOUDFLARE":r("Deno/")?"DENO":r("Node.js/")?"NODE":s.Bun&&"string"==typeof Bun.version?"BUN":s.Deno&&"object"==typeof Deno.version?"DENO":"process"===o(s.process)?"NODE":s.window&&s.document?"BROWSER":"REST"}()},8960:function(e,t,a){"use strict";a("b247")},9485:function(e,t,a){"use strict";var s=a("23e7"),l=a("2266"),o=a("59ed"),r=a("825a"),i=a("46c4"),n=TypeError;s({target:"Iterator",proto:!0,real:!0},{reduce:function(e){r(this),o(e);var t=i(this),a=arguments.length<2,s=a?void 0:arguments[1],c=0;if(l(t,(function(t){a?(a=!1,s=t):s=e(s,t,c),c++}),{IS_RECORD:!0}),a)throw new n("Reduce of empty iterator with no initial value");return s}})},"9adc":function(e,t,a){"use strict";var s=a("8558");e.exports="NODE"===s},a640:function(e,t,a){"use strict";var s=a("d039");e.exports=function(e,t){var a=[][e];return!!a&&s((function(){a.call(null,t||function(){return 1},1)}))}},a868:function(e,t,a){"use strict";a("3b94")},b247:function(e,t,a){},c4b3:function(e,t,a){"use strict";var s=function(){var e=this,t=e._self._c;return t("div",{staticClass:"column-filter"},[t("el-button",{attrs:{type:e.buttonType,size:e.buttonSize,icon:e.buttonIcon},on:{click:e.showDialog}},[e._v(" "+e._s(e.buttonText)+" ")]),t("el-dialog",{attrs:{title:e.dialogTitle,visible:e.dialogVisible,width:"500px","append-to-body":""},on:{"update:visible":function(t){e.dialogVisible=t}}},[t("div",{staticClass:"column-filter-container"},[t("el-checkbox",{on:{change:e.handleSelectAllChange},model:{value:e.selectAllColumns,callback:function(t){e.selectAllColumns=t},expression:"selectAllColumns"}},[e._v("全选")]),t("el-divider"),t("el-checkbox-group",{on:{change:e.handleColumnChange},model:{value:e.selectedColumns,callback:function(t){e.selectedColumns=t},expression:"selectedColumns"}},[t("el-row",{attrs:{gutter:10}},e._l(e.availableColumns,(function(a){return t("el-col",{key:a.prop,attrs:{span:8}},[t("el-checkbox",{attrs:{label:a.prop}},[e._v(e._s(a.label))])],1)})),1)],1)],1),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:e.resetColumns}},[e._v("重置")]),t("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.saveColumnSettings}},[e._v("确 定")])],1)])],1)},l=[],o=(a("e9f5"),a("7d54"),a("ab43"),{name:"ColumnFilter",props:{storageKey:{type:String,required:!0},columns:{type:Array,required:!0},defaultSelected:{type:Array,required:!0},buttonType:{type:String,default:"primary"},buttonSize:{type:String,default:"small"},buttonIcon:{type:String,default:"el-icon-s-operation"},buttonText:{type:String,default:"列筛选"},dialogTitle:{type:String,default:"列筛选设置"}},data(){return{dialogVisible:!1,selectedColumns:[...this.defaultSelected],selectAllColumns:!1,visibleColumns:{}}},computed:{availableColumns(){return this.columns}},created(){this.loadColumnSettings()},methods:{showDialog(){this.dialogVisible=!0},handleSelectAllChange(e){this.selectedColumns=e?this.availableColumns.map(e=>e.prop):[],this.updateVisibleColumns()},handleColumnChange(){this.selectAllColumns=this.selectedColumns.length===this.availableColumns.length,this.updateVisibleColumns()},updateVisibleColumns(){const e={};this.availableColumns.forEach(t=>{e[t.prop]=!1}),this.selectedColumns.forEach(t=>{e[t]=!0}),this.visibleColumns=e,this.$emit("update:visible-columns",{...e})},saveColumnSettings(){try{localStorage.setItem(this.storageKey+"Columns",JSON.stringify(this.selectedColumns)),localStorage.setItem(this.storageKey+"VisibleColumns",JSON.stringify(this.visibleColumns)),this.dialogVisible=!1,this.$message.success("列设置已保存"),this.$emit("update:visible-columns",{...this.visibleColumns})}catch(e){console.error("保存列设置失败",e),this.$message.error("保存列设置失败")}},loadColumnSettings(){try{const e=localStorage.getItem(this.storageKey+"Columns"),t=localStorage.getItem(this.storageKey+"VisibleColumns");e?(this.selectedColumns=JSON.parse(e),this.selectAllColumns=this.selectedColumns.length===this.availableColumns.length):(this.selectedColumns=[...this.defaultSelected],this.selectAllColumns=this.selectedColumns.length===this.availableColumns.length),t?this.visibleColumns=JSON.parse(t):this.updateVisibleColumns(),this.$emit("update:visible-columns",{...this.visibleColumns})}catch(e){console.error("加载列设置失败",e),this.resetColumns()}},resetColumns(){this.selectedColumns=[...this.defaultSelected],this.selectAllColumns=this.selectedColumns.length===this.availableColumns.length,this.updateVisibleColumns()}}}),r=o,i=(a("ec91"),a("2877")),n=Object(i["a"])(r,s,l,!1,null,null,null);t["a"]=n.exports},d58f:function(e,t,a){"use strict";var s=a("59ed"),l=a("7b0b"),o=a("44ad"),r=a("07fa"),i=TypeError,n="Reduce of empty array with no initial value",c=function(e){return function(t,a,c,m){var u=l(t),d=o(u),p=r(u);if(s(a),0===p&&c<2)throw new i(n);var h=e?p-1:0,f=e?-1:1;if(c<2)while(1){if(h in d){m=d[h],h+=f;break}if(h+=f,e?h<0:p<=h)throw new i(n)}for(;e?h>=0:p>h;h+=f)h in d&&(m=a(m,d[h],h,u));return m}};e.exports={left:c(!1),right:c(!0)}},ec91:function(e,t,a){"use strict";a("3741")},f449:function(e,t,a){"use strict";a.r(t);var s=function(){var e=this,t=e._self._c;return t("div",{key:e.componentKey,staticClass:"performance-container"},[t("div",{staticClass:"performance-status-tabs"},[t("el-tabs",{attrs:{type:"card"},on:{"tab-click":e.handleStatusTabClick},model:{value:e.activeStatus,callback:function(t){e.activeStatus=t},expression:"activeStatus"}},[t("el-tab-pane",{attrs:{label:"草稿",name:"draft"}},[t("span",{attrs:{slot:"label"},slot:"label"},[t("i",{staticClass:"el-icon-edit-outline"}),e._v(" 草稿 ")])]),t("el-tab-pane",{attrs:{label:"待审核",name:"pending"}},[t("span",{attrs:{slot:"label"},slot:"label"},[t("i",{staticClass:"el-icon-time"}),e._v(" 待审核 ")])]),t("el-tab-pane",{attrs:{label:"已审核",name:"approved"}},[t("span",{attrs:{slot:"label"},slot:"label"},[t("i",{staticClass:"el-icon-success"}),e._v(" 已审核 ")])]),t("el-tab-pane",{attrs:{label:"已退回",name:"rejected"}},[t("span",{attrs:{slot:"label"},slot:"label"},[t("i",{staticClass:"el-icon-warning"}),e._v(" 已退回 ")])]),t("el-tab-pane",{attrs:{label:"已作废",name:"cancelled"}},[t("span",{attrs:{slot:"label"},slot:"label"},[t("i",{staticClass:"el-icon-delete"}),e._v(" 已作废 ")])]),t("el-tab-pane",{attrs:{label:"全部",name:"all"}})],1)],1),t("div",{staticClass:"body-part-search"},[t("el-form",{ref:"searchForm",attrs:{model:e.searchForm,"label-width":"100px"}},[t("div",{staticClass:"default-filters"},[t("el-row",[t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"业绩单号",prop:"performanceNo"}},[t("el-input",{staticClass:"filter-item",attrs:{placeholder:"业绩单号",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}},model:{value:e.searchForm.performanceNo,callback:function(t){e.$set(e.searchForm,"performanceNo",t)},expression:"searchForm.performanceNo"}})],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"合同号",prop:"contractNo"}},[t("el-input",{staticClass:"filter-item",attrs:{placeholder:"合同号",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}},model:{value:e.searchForm.contractNo,callback:function(t){e.$set(e.searchForm,"contractNo",t)},expression:"searchForm.contractNo"}})],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"客户名称",prop:"customerName"}},[t("el-input",{staticClass:"filter-item",attrs:{placeholder:"客户名称",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}},model:{value:e.searchForm.customerName,callback:function(t){e.$set(e.searchForm,"customerName",t)},expression:"searchForm.customerName"}})],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"业务人员",prop:"salesman"}},[t("el-input",{staticClass:"filter-item",attrs:{placeholder:"业务人员",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}},model:{value:e.searchForm.salesman,callback:function(t){e.$set(e.searchForm,"salesman",t)},expression:"searchForm.salesman"}})],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"业绩类型",prop:"performanceType"}},[t("el-select",{staticClass:"filter-item",attrs:{placeholder:"业绩类型",clearable:"",size:"small"},model:{value:e.searchForm.performanceType,callback:function(t){e.$set(e.searchForm,"performanceType",t)},expression:"searchForm.performanceType"}},[t("el-option",{attrs:{label:"有项目",value:"with_case"}}),t("el-option",{attrs:{label:"无项目",value:"without_case"}})],1)],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"状态",prop:"status"}},[t("el-select",{staticClass:"filter-item",attrs:{placeholder:"状态",clearable:"",size:"small"},model:{value:e.searchForm.status,callback:function(t){e.$set(e.searchForm,"status",t)},expression:"searchForm.status"}},[t("el-option",{attrs:{label:"草稿",value:"draft"}}),t("el-option",{attrs:{label:"待审核",value:"pending"}}),t("el-option",{attrs:{label:"已审核",value:"approved"}}),t("el-option",{attrs:{label:"已退回",value:"rejected"}}),t("el-option",{attrs:{label:"已作废",value:"cancelled"}})],1)],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"创建时间",prop:"createTimeRange"}},[t("el-date-picker",{staticClass:"filter-item",attrs:{type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",size:"small","value-format":"yyyy-MM-dd"},model:{value:e.searchForm.createTimeRange,callback:function(t){e.$set(e.searchForm,"createTimeRange",t)},expression:"searchForm.createTimeRange"}})],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"金额范围",prop:"amountRange"}},[t("div",{staticClass:"custom-range-input"},[t("el-input",{staticClass:"custom-range-item",attrs:{placeholder:"最小金额",size:"small"},model:{value:e.searchForm.minAmount,callback:function(t){e.$set(e.searchForm,"minAmount",t)},expression:"searchForm.minAmount"}}),t("span",{staticClass:"custom-range-separator"},[e._v("-")]),t("el-input",{staticClass:"custom-range-item",attrs:{placeholder:"最大金额",size:"small"},model:{value:e.searchForm.maxAmount,callback:function(t){e.$set(e.searchForm,"maxAmount",t)},expression:"searchForm.maxAmount"}})],1)])],1)],1)],1),e.expandSearchVisible?t("div",[t("el-row",[t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"项目号",prop:"caseNo"}},[t("el-input",{staticClass:"filter-item",attrs:{placeholder:"项目号",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}},model:{value:e.searchForm.caseNo,callback:function(t){e.$set(e.searchForm,"caseNo",t)},expression:"searchForm.caseNo"}})],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"审核人",prop:"approver"}},[t("el-input",{staticClass:"filter-item",attrs:{placeholder:"审核人",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}},model:{value:e.searchForm.approver,callback:function(t){e.$set(e.searchForm,"approver",t)},expression:"searchForm.approver"}})],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"审核时间",prop:"approveTimeRange"}},[t("el-date-picker",{staticClass:"filter-item",attrs:{type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",size:"small","value-format":"yyyy-MM-dd"},model:{value:e.searchForm.approveTimeRange,callback:function(t){e.$set(e.searchForm,"approveTimeRange",t)},expression:"searchForm.approveTimeRange"}})],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{label:"创建人",prop:"creator"}},[t("el-input",{staticClass:"filter-item",attrs:{placeholder:"创建人",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}},model:{value:e.searchForm.creator,callback:function(t){e.$set(e.searchForm,"creator",t)},expression:"searchForm.creator"}})],1)],1)],1)],1):e._e()]),t("div",{staticClass:"part-search-buttons"},[t("el-button",{attrs:{size:"small",type:"primary",icon:"el-icon-search"},on:{click:e.handleSearch}},[e._v("搜索")]),t("el-button",{attrs:{size:"small",icon:"el-icon-refresh"},on:{click:e.resetSearch}},[e._v("重置")]),t("el-button",{attrs:{size:"small",type:"primary"},on:{click:function(t){e.expandSearchVisible=!e.expandSearchVisible}}},[e._v(" "+e._s(e.expandSearchVisible?"收起":"展开")+" "),t("i",{class:e.expandSearchVisible?"el-icon-arrow-up":"el-icon-arrow-down"})])],1)],1),t("div",{staticClass:"body-part-content"},[t("div",{staticClass:"part-table-header"},[e._m(0),t("div",{staticClass:"part-table-operations"},[t("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.handleExport}},[e._v("导出")]),t("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.handleAdd}},[e._v("新增业绩单")]),t("column-filter",{attrs:{"storage-key":"performance",columns:e.availableColumns,"default-selected":e.defaultSelectedColumns},on:{"update:visible-columns":e.updateVisibleColumns}})],1)]),t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{data:e.tableData,border:"",size:"small","row-key":"id"},on:{"selection-change":e.handleSelectionChange}},[t("el-table-column",{attrs:{type:"selection",width:"80",align:"center"}}),t("el-table-column",{attrs:{type:"index",label:"序号",width:"60",align:"center"}}),e._l(e.visibleColumns,(function(a){return t("el-table-column",{key:a.prop,attrs:{prop:a.prop,label:a.label,width:a.width,"min-width":a.minWidth,"show-overflow-tooltip":a.showOverflowTooltip,align:"center"},scopedSlots:e._u([{key:"default",fn:function(s){return["performanceType"===a.prop?t("el-tag",{attrs:{type:"with_case"===s.row.performanceType?"success":"info",size:"small"}},[e._v(" "+e._s("with_case"===s.row.performanceType?"有项目":"无项目")+" ")]):"status"===a.prop?t("el-tag",{attrs:{type:e.getStatusType(s.row.status),size:"small"}},[e._v(" "+e._s(e.getStatusText(s.row.status))+" ")]):"performanceAllocation"===a.prop?t("div",{staticClass:"allocation-list"},e._l(s.row.allocations,(function(a,s){return t("div",{key:s,staticClass:"allocation-item"},[e._v(" "+e._s(a.name)+": ¥"+e._s(a.amount)+" ")])})),0):t("span",[e._v(e._s(s.row[a.prop]))])]}}],null,!0)})})),t("el-table-column",{attrs:{fixed:"right",label:"操作",align:"center",width:"200","class-name":"small-padding fixed-width"},scopedSlots:e._u([{key:"default",fn:function(a){return[t("el-button",{attrs:{size:"mini",type:"text",icon:"el-icon-view"},on:{click:function(t){return e.handleView(a.row)}}},[e._v("查看")]),"draft"===a.row.status?t("el-button",{attrs:{size:"mini",type:"text",icon:"el-icon-edit"},on:{click:function(t){return e.handleEdit(a.row)}}},[e._v("编辑")]):e._e(),"draft"===a.row.status?t("el-button",{attrs:{size:"mini",type:"text",icon:"el-icon-check"},on:{click:function(t){return e.handleSubmit(a.row)}}},[e._v("提交审核")]):e._e(),"approved"===a.row.status&&"claimed"===a.row.claimStatus?t("el-button",{attrs:{size:"mini",type:"text",icon:"el-icon-refresh-left"},on:{click:function(t){return e.handleUnclaim(a.row)}}},[e._v("退回认领")]):e._e(),["draft","rejected"].includes(a.row.status)?t("el-button",{attrs:{size:"mini",type:"text",icon:"el-icon-delete"},on:{click:function(t){return e.handleDelete(a.row)}}},[e._v("删除")]):e._e()]}}])})],2),t("el-pagination",{directives:[{name:"show",rawName:"v-show",value:e.pagination.total>0,expression:"pagination.total > 0"}],attrs:{total:e.pagination.total,"current-page":e.pagination.currentPage,"page-sizes":[10,20,50,100],"page-size":e.pagination.pageSize,layout:"total, sizes, prev, pager, next, jumper"},on:{"size-change":e.handleSizeChange,"current-change":e.handleCurrentChange}})],1),t("el-dialog",{attrs:{title:e.dialogTitle,visible:e.dialogVisible,width:"70%","before-close":e.handleDialogClose},on:{"update:visible":function(t){e.dialogVisible=t}}},[e.dialogVisible?t("performance-form",{attrs:{"form-data":e.currentRow,mode:e.dialogMode},on:{save:e.handleSavePerformance,cancel:e.handleDialogClose}}):e._e()],1)],1)},l=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"part-table-title"},[t("span",[e._v("业绩单管理")])])}],o=(a("14d9"),a("e9f5"),a("910d"),a("c4b3")),r=function(){var e=this,t=e._self._c;return t("div",{staticClass:"performance-form"},[t("el-form",{ref:"performanceForm",attrs:{model:e.form,rules:e.rules,"label-width":"100px",size:"small"}},[t("div",{staticClass:"form-section"},[t("div",{staticClass:"section-title"},[e._v("基础信息")]),t("el-row",{attrs:{gutter:20}},[t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"业绩单号",prop:"performanceNo"}},[t("el-input",{attrs:{placeholder:"系统自动生成",disabled:!0},model:{value:e.form.performanceNo,callback:function(t){e.$set(e.form,"performanceNo",t)},expression:"form.performanceNo"}})],1)],1),t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"业绩类型",prop:"performanceType",required:!0}},[t("el-radio-group",{attrs:{disabled:"view"===e.mode},on:{change:e.handleTypeChange},model:{value:e.form.performanceType,callback:function(t){e.$set(e.form,"performanceType",t)},expression:"form.performanceType"}},[t("el-radio",{attrs:{label:"with_case"}},[e._v("有项目")]),t("el-radio",{attrs:{label:"without_case"}},[e._v("无项目")])],1)],1)],1)],1),t("el-row",{attrs:{gutter:20}},[t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"选择合同",prop:"contractId",required:!0}},[t("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择合同",filterable:"",remote:"","remote-method":e.searchContracts,loading:e.contractLoading,disabled:"view"===e.mode},on:{change:e.handleContractChange},model:{value:e.form.contractId,callback:function(t){e.$set(e.form,"contractId",t)},expression:"form.contractId"}},e._l(e.contractOptions,(function(e){return t("el-option",{key:e.id,attrs:{label:`${e.contractNo} - ${e.contractName} (${e.customerName})`,value:e.id}})})),1)],1)],1),e.selectedContract?t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"合同信息"}},[t("div",{staticClass:"contract-info"},[t("div",[e._v("客户："+e._s(e.selectedContract.customerName))]),t("div",[e._v("业务员："+e._s(e.selectedContract.salesman))]),t("div",[e._v("总金额：¥"+e._s(e.selectedContract.totalAmount))])])])],1):e._e()],1)],1),"with_case"===e.form.performanceType?t("div",{staticClass:"form-section"},[t("div",{staticClass:"section-title"},[e._v("项目信息")]),t("el-form-item",{attrs:{label:"选择项目",prop:"caseIds",required:!0}},[t("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择项目",multiple:"",filterable:"",disabled:"view"===e.mode||!e.form.contractId},model:{value:e.form.caseIds,callback:function(t){e.$set(e.form,"caseIds",t)},expression:"form.caseIds"}},e._l(e.caseOptions,(function(e){return t("el-option",{key:e.id,attrs:{label:`${e.caseNo} - ${e.caseName} (服务费: ¥${e.serviceFee})`,value:e.id}})})),1)],1),e.selectedCases.length>0?t("div",{staticClass:"selected-cases"},[t("div",{staticClass:"cases-title"},[e._v("已选择项目：")]),t("el-table",{attrs:{data:e.selectedCases,border:"",size:"small"}},[t("el-table-column",{attrs:{prop:"caseNo",label:"项目号",width:"120"}}),t("el-table-column",{attrs:{prop:"caseName",label:"项目名称"}}),t("el-table-column",{attrs:{prop:"serviceFee",label:"服务费",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" ¥"+e._s(t.row.serviceFee)+" ")]}}],null,!1,3902163171)}),t("el-table-column",{attrs:{prop:"status",label:"状态",width:"100"}})],1),t("div",{staticClass:"cases-summary"},[e._v(" 总服务费：¥"+e._s(e.totalCaseServiceFee)+" ")])],1):e._e()],1):e._e(),"without_case"===e.form.performanceType?t("div",{staticClass:"form-section"},[t("div",{staticClass:"section-title"},[e._v("到账信息")]),t("el-row",{attrs:{gutter:20}},[t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"到账金额",prop:"receivedAmount",required:!0}},[t("el-input",{attrs:{placeholder:"请输入到账金额",disabled:"view"===e.mode},on:{input:e.updateTotalAmount},model:{value:e.form.receivedAmount,callback:function(t){e.$set(e.form,"receivedAmount",t)},expression:"form.receivedAmount"}},[t("template",{slot:"prepend"},[e._v("¥")])],2)],1)],1),t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:"到账日期",prop:"receivedDate"}},[t("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"date",placeholder:"请选择到账日期",disabled:"view"===e.mode,"value-format":"yyyy-MM-dd"},model:{value:e.form.receivedDate,callback:function(t){e.$set(e.form,"receivedDate",t)},expression:"form.receivedDate"}})],1)],1)],1),t("el-form-item",{attrs:{label:"后续项目关联"}},[t("el-alert",{attrs:{title:"提示：当后续有项目时，需要将此业绩单与具体项目进行关联",type:"info",closable:!1,"show-icon":""}})],1)],1):e._e(),t("div",{staticClass:"form-section"},[t("div",{staticClass:"section-title"},[e._v(" 业绩分配 "),t("el-button",{staticStyle:{"margin-left":"10px"},attrs:{type:"primary",size:"mini",disabled:"view"===e.mode},on:{click:e.addAllocation}},[e._v(" 添加分配 ")])],1),t("div",{staticClass:"allocation-list"},e._l(e.form.allocations,(function(a,s){return t("div",{key:s,staticClass:"allocation-item"},[t("el-row",{attrs:{gutter:10}},[t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{prop:`allocations.${s}.userId`,rules:{required:!0,message:"请选择业务人员",trigger:"change"}}},[t("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择业务人员",filterable:"",disabled:"view"===e.mode},on:{change:function(t){return e.handleUserChange(s,t)}},model:{value:a.userId,callback:function(t){e.$set(a,"userId",t)},expression:"allocation.userId"}},e._l(e.userOptions,(function(e){return t("el-option",{key:e.id,attrs:{label:e.name,value:e.id}})})),1)],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{prop:`allocations.${s}.amount`,rules:{required:!0,message:"请输入分配金额",trigger:"blur"}}},[t("el-input",{attrs:{placeholder:"分配金额",disabled:"view"===e.mode},on:{input:e.calculateRemaining},model:{value:a.amount,callback:function(t){e.$set(a,"amount",t)},expression:"allocation.amount"}},[t("template",{slot:"prepend"},[e._v("¥")])],2)],1)],1),t("el-col",{attrs:{span:4}},[t("el-form-item",{attrs:{prop:`allocations.${s}.percentage`}},[t("el-input",{attrs:{placeholder:"占比%",disabled:!0},model:{value:a.percentage,callback:function(t){e.$set(a,"percentage",t)},expression:"allocation.percentage"}},[t("template",{slot:"append"},[e._v("%")])],2)],1)],1),t("el-col",{attrs:{span:6}},[t("el-form-item",{attrs:{prop:`allocations.${s}.remark`}},[t("el-input",{attrs:{placeholder:"备注",disabled:"view"===e.mode},model:{value:a.remark,callback:function(t){e.$set(a,"remark",t)},expression:"allocation.remark"}})],1)],1),t("el-col",{attrs:{span:2}},[t("el-button",{attrs:{type:"danger",size:"mini",icon:"el-icon-delete",disabled:"view"===e.mode||e.form.allocations.length<=1},on:{click:function(t){return e.removeAllocation(s)}}})],1)],1)],1)})),0),t("div",{staticClass:"allocation-summary"},[t("el-row",{attrs:{gutter:20}},[t("el-col",{attrs:{span:8}},[t("div",{staticClass:"summary-item"},[t("span",{staticClass:"label"},[e._v("总金额：")]),t("span",{staticClass:"value"},[e._v("¥"+e._s(e.form.totalAmount||"0.00"))])])]),t("el-col",{attrs:{span:8}},[t("div",{staticClass:"summary-item"},[t("span",{staticClass:"label"},[e._v("已分配：")]),t("span",{staticClass:"value"},[e._v("¥"+e._s(e.allocatedAmount))])])]),t("el-col",{attrs:{span:8}},[t("div",{staticClass:"summary-item"},[t("span",{staticClass:"label"},[e._v("剩余：")]),t("span",{staticClass:"value",class:{error:e.remainingAmount<0}},[e._v(" ¥"+e._s(e.remainingAmount)+" ")])])])],1)],1)]),t("div",{staticClass:"form-section"},[t("div",{staticClass:"section-title"},[e._v("其他信息")]),t("el-form-item",{attrs:{label:"备注",prop:"remark"}},[t("el-input",{attrs:{type:"textarea",rows:3,placeholder:"请输入备注信息",disabled:"view"===e.mode},model:{value:e.form.remark,callback:function(t){e.$set(e.form,"remark",t)},expression:"form.remark"}})],1)],1)]),"view"!==e.mode?t("div",{staticClass:"form-actions"},[t("el-button",{on:{click:e.handleCancel}},[e._v("取消")]),t("el-button",{attrs:{size:"small",type:"primary",loading:e.saving},on:{click:e.handleSaveDraft}},[e._v("保存草稿")]),t("el-button",{attrs:{type:"success",loading:e.submitting},on:{click:e.handleSubmit}},[e._v("提交审核")])],1):e._e()],1)},i=[],n=(a("13d5"),a("f665"),a("7d54"),a("9485"),a("a732"),{name:"PerformanceForm",props:{formData:{type:Object,default:null},mode:{type:String,default:"add"}},data(){return{form:{id:null,performanceNo:"",performanceType:"with_case",contractId:"",caseIds:[],receivedAmount:"",receivedDate:"",totalAmount:"",allocations:[{userId:"",userName:"",amount:"",percentage:"",remark:""}],remark:"",status:"draft"},rules:{performanceType:[{required:!0,message:"请选择业绩类型",trigger:"change"}],contractId:[{required:!0,message:"请选择合同",trigger:"change"}],caseIds:[{required:!0,message:"请选择项目",trigger:"change"}],receivedAmount:[{required:!0,message:"请输入到账金额",trigger:"blur"},{pattern:/^\d+(\.\d{1,2})?$/,message:"请输入正确的金额格式",trigger:"blur"}]},contractOptions:[],caseOptions:[],userOptions:[],selectedContract:null,selectedCases:[],contractLoading:!1,saving:!1,submitting:!1}},computed:{totalCaseServiceFee(){return this.selectedCases.reduce((e,t)=>e+parseFloat(t.serviceFee||0),0).toFixed(2)},allocatedAmount(){return this.form.allocations.reduce((e,t)=>e+parseFloat(t.amount||0),0).toFixed(2)},remainingAmount(){const e=parseFloat(this.form.totalAmount||0),t=parseFloat(this.allocatedAmount||0);return(e-t).toFixed(2)}},watch:{formData:{handler(e){e&&this.initForm(e)},immediate:!0},"form.caseIds":{handler(e){this.updateSelectedCases(e)}}},created(){this.loadUserOptions(),this.formData||this.generatePerformanceNo()},methods:{initForm(e){this.form={...this.form,...e,allocations:e.allocations||[{userId:"",userName:"",amount:"",percentage:"",remark:""}]}},generatePerformanceNo(){const e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),l=String(Math.floor(1e3*Math.random())).padStart(3,"0");this.form.performanceNo=`YJ${t}${a}${s}${l}`},handleTypeChange(e){this.form.caseIds=[],this.form.receivedAmount="",this.form.receivedDate="",this.selectedCases=[],this.form.totalAmount="with_case"===e?this.totalCaseServiceFee:this.form.receivedAmount},searchContracts(e){""!==e?(this.contractLoading=!0,setTimeout(()=>{this.contractOptions=[{id:"1",contractNo:"LS10001",contractName:"商标注册服务合同",customerName:"北京科技有限公司",salesman:"张三",totalAmount:"50000.00"},{id:"2",contractNo:"LS10002",contractName:"专利申请服务合同",customerName:"上海实业有限公司",salesman:"李四",totalAmount:"80000.00"}].filter(t=>t.contractNo.toLowerCase().includes(e.toLowerCase())||t.contractName.toLowerCase().includes(e.toLowerCase())||t.customerName.toLowerCase().includes(e.toLowerCase())),this.contractLoading=!1},300)):this.contractOptions=[]},handleContractChange(e){const t=this.contractOptions.find(t=>t.id===e);t&&(this.selectedContract=t,this.loadCaseOptions(e))},loadCaseOptions(e){setTimeout(()=>{this.caseOptions=[{id:"1",caseNo:"AN30001",caseName:"商标注册项目1",serviceFee:"15000.00",status:"进行中"},{id:"2",caseNo:"AN30002",caseName:"商标注册项目2",serviceFee:"12000.00",status:"已完成"},{id:"3",caseNo:"AN30003",caseName:"专利申请项目1",serviceFee:"25000.00",status:"进行中"}]},300)},updateSelectedCases(e){this.selectedCases=this.caseOptions.filter(t=>e.includes(t.id)),"with_case"===this.form.performanceType&&(this.form.totalAmount=this.totalCaseServiceFee,this.calculateRemaining())},updateTotalAmount(){"without_case"===this.form.performanceType&&(this.form.totalAmount=this.form.receivedAmount,this.calculateRemaining())},loadUserOptions(){this.userOptions=[{id:"1",name:"张三"},{id:"2",name:"李四"},{id:"3",name:"王五"},{id:"4",name:"赵六"},{id:"5",name:"孙七"}]},addAllocation(){this.form.allocations.push({userId:"",userName:"",amount:"",percentage:"",remark:""})},removeAllocation(e){this.form.allocations.length>1&&(this.form.allocations.splice(e,1),this.calculateRemaining())},handleUserChange(e,t){const a=this.userOptions.find(e=>e.id===t);a&&(this.form.allocations[e].userName=a.name)},calculateRemaining(){const e=parseFloat(this.form.totalAmount||0);this.form.allocations.forEach(t=>{const a=parseFloat(t.amount||0);t.percentage=e>0?(a/e*100).toFixed(2):"0.00"})},validateForm(){return new Promise(e=>{this.$refs.performanceForm.validate(t=>{if(!t)return void e(!1);if("with_case"===this.form.performanceType&&(!this.form.caseIds||0===this.form.caseIds.length))return this.$message.error("请选择项目"),void e(!1);if("without_case"===this.form.performanceType&&!this.form.receivedAmount)return this.$message.error("请输入到账金额"),void e(!1);const a=parseFloat(this.form.totalAmount||0),s=parseFloat(this.allocatedAmount||0);if(Math.abs(a-s)>.01)return this.$message.error("分配金额必须等于总金额"),void e(!1);const l=this.form.allocations.some(e=>!e.userId);if(l)return this.$message.error("请为所有分配项选择业务人员"),void e(!1);const o=this.form.allocations.some(e=>!e.amount||parseFloat(e.amount)<=0);if(o)return this.$message.error("请为所有分配项输入正确的金额"),void e(!1);e(!0)})})},async handleSaveDraft(){const e=await this.validateForm();if(e){this.saving=!0;try{setTimeout(()=>{this.form.status="draft",this.$emit("save",this.form),this.saving=!1},1e3)}catch(t){this.$message.error("保存失败"),this.saving=!1}}},async handleSubmit(){const e=await this.validateForm();if(e){this.submitting=!0;try{setTimeout(()=>{this.form.status="pending",this.$emit("save",this.form),this.submitting=!1},1e3)}catch(t){this.$message.error("提交失败"),this.submitting=!1}}},handleCancel(){this.$emit("cancel")}}}),c=n,m=(a("a868"),a("2877")),u=Object(m["a"])(c,r,i,!1,null,"ebfd7eb4",null),d=u.exports,p={name:"Performance",components:{ColumnFilter:o["a"],PerformanceForm:d},data(){return{componentKey:0,loading:!1,expandSearchVisible:!1,dialogVisible:!1,dialogMode:"add",currentRow:null,searchForm:{performanceNo:"",contractNo:"",customerName:"",salesman:"",performanceType:"",status:"",createTimeRange:[],minAmount:"",maxAmount:"",caseNo:"",approver:"",approveTimeRange:[],creator:""},visibleColumns:[],availableColumns:[{prop:"performanceNo",label:"业绩单号",width:"140"},{prop:"contractNo",label:"合同号",width:"140"},{prop:"contractName",label:"合同名称",minWidth:"180",showOverflowTooltip:!0},{prop:"customerName",label:"客户名称",width:"150"},{prop:"performanceType",label:"业绩类型",width:"100"},{prop:"caseNo",label:"关联项目",width:"140"},{prop:"totalAmount",label:"业绩总金额",width:"120"},{prop:"performanceAllocation",label:"业绩分配",minWidth:"200"},{prop:"status",label:"状态",width:"100"},{prop:"creator",label:"创建人",width:"100"},{prop:"createTime",label:"创建时间",width:"160"},{prop:"approver",label:"审核人",width:"100"},{prop:"approveTime",label:"审核时间",width:"160"},{prop:"remark",label:"备注",minWidth:"150",showOverflowTooltip:!0},{prop:"claimStatus",label:"认领状态",width:"100"}],defaultSelectedColumns:["performanceNo","contractNo","customerName","performanceType","totalAmount","performanceAllocation","status","creator","createTime"],tableData:[],pagination:{currentPage:1,pageSize:10,total:800},selectedRows:[],activeStatus:"draft"}},computed:{dialogTitle(){const e={add:"新增业绩单",edit:"编辑业绩单",view:"查看业绩单"};return e[this.dialogMode]||"业绩单"},currentRoute(){return this.$route.path}},watch:{currentRoute:{handler(){this.fetchData()},immediate:!0},$route:{handler(){this.refreshComponent()},immediate:!0,deep:!0}},created(){this.updateVisibleColumns(this.defaultSelectedColumns),this.fetchData()},mounted(){const e=this.$route.query.status;e&&(this.activeStatus=e,this.handleStatusTabClick())},methods:{refreshComponent(){this.componentKey+=1},updateVisibleColumns(e){const t=Array.isArray(e)?e:e&&"object"===typeof e?Object.keys(e).filter(t=>e[t]):[];this.visibleColumns=this.availableColumns.filter(e=>t.includes(e.prop)),0===this.visibleColumns.length&&this.availableColumns.length>0&&(this.visibleColumns=[...this.availableColumns])},getStatusType(e){const t={draft:"info",pending:"warning",approved:"success",rejected:"danger",cancelled:"info"};return t[e]||"info"},getStatusText(e){const t={draft:"草稿",pending:"待审核",approved:"已审核",rejected:"已退回",cancelled:"已作废"};return t[e]||e},resetSearch(){this.searchForm={performanceNo:"",contractNo:"",customerName:"",salesman:"",performanceType:"",status:"",createTimeRange:[],minAmount:"",maxAmount:"",caseNo:"",approver:"",approveTimeRange:[],creator:""},this.handleSearch()},handleSearch(){this.pagination.currentPage=1,this.fetchData()},handleAdd(){this.dialogMode="add",this.currentRow=null,this.dialogVisible=!0},handleEdit(e){this.dialogMode="edit",this.currentRow={...e},this.dialogVisible=!0},handleView(e){this.dialogMode="view",this.currentRow={...e},this.dialogVisible=!0},handleSubmit(e){this.$confirm("确定要提交审核吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.loading=!0,setTimeout(()=>{e.status="pending",this.$message.success("提交审核成功"),this.loading=!1,this.fetchData()},1e3)})},handleUnclaim(e){this.$confirm("确定要退回认领状态吗？退回后该业绩单将变为未认领状态。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.loading=!0,setTimeout(()=>{e.claimStatus="unclaimed",this.$message.success("退回认领成功"),this.loading=!1,this.fetchData()},1e3)})},handleDelete(e){this.$confirm("确定要删除这条业绩单吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.loading=!0,setTimeout(()=>{const t=this.tableData.findIndex(t=>t.id===e.id);t>-1&&this.tableData.splice(t,1),this.$message.success("删除成功"),this.loading=!1},1e3)})},handleExport(){console.log("导出业绩单数据"),this.$message.info("导出功能开发中...")},handleDialogClose(){this.dialogVisible=!1,this.currentRow=null},handleSavePerformance(e){console.log("保存业绩单:",e),this.dialogVisible=!1,this.$message.success("保存成功"),this.fetchData()},fetchData(){this.loading=!0,setTimeout(()=>{const e=[];for(let t=0;t<10;t++){const a=new Date,s=Math.floor(365*Math.random()),l=new Date(a.getTime()-24*s*60*60*1e3),o=e=>e.toISOString().replace("T"," ").slice(0,19),r=["draft","pending","approved","rejected","cancelled"],i=["with_case","without_case"],n=["claimed","unclaimed"],c=[],m=Math.floor(3*Math.random())+1,u=Math.floor(5e4*Math.random())+5e3;for(let e=0;e<m;e++)c.push({name:"业务员"+(e+1),amount:(u/m).toFixed(2)});e.push({id:(t+1).toString(),performanceNo:"YJ"+String(2e4+t).padStart(5,"0"),contractNo:"LS"+String(1e4+t).padStart(5,"0"),contractName:"知识产权服务合同"+(t+1),customerName:"客户"+String(t+1).padStart(2,"0"),performanceType:i[Math.floor(Math.random()*i.length)],caseNo:Math.random()>.5?"AN"+String(3e4+t).padStart(5,"0"):"",totalAmount:u.toFixed(2),allocations:c,status:r[Math.floor(Math.random()*r.length)],creator:"创建人"+String(t+1).padStart(2,"0"),createTime:o(l),approver:Math.random()>.3?"审核人"+String(t+1).padStart(2,"0"):"",approveTime:Math.random()>.3?o(new Date(l.getTime()+864e5)):"",remark:"业绩单备注"+(t+1),claimStatus:n[Math.floor(Math.random()*n.length)]})}this.tableData=e,this.loading=!1},500)},handleSelectionChange(e){this.selectedRows=e},handleSizeChange(e){this.pagination.pageSize=e,this.fetchData()},handleCurrentChange(e){this.pagination.currentPage=e,this.fetchData()},handleStatusTabClick(e){"all"===this.activeStatus?this.searchForm.status="":this.searchForm.status=this.activeStatus,this.$router.replace({query:{...this.$route.query,status:this.activeStatus}}).catch(()=>{}),this.handleSearch()}}},h=p,f=(a("8960"),Object(m["a"])(h,s,l,!1,null,"9d2ec346",null));t["default"]=f.exports}}]);